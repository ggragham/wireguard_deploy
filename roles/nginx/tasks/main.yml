---
- name: Install and config webserver
  block:
    - name: Install nginx
      block:
        - name: Create Nginx directory struct
          file:
            path: '{{ directory }}'
            state: directory
            owner: '{{ NGINX_USER }}'
            group: root
            mode: 0755
          loop_control:
            loop_var: directory
          loop:
            - '{{ NGINX_LOG_PATH }}'
            - '{{ NGINX_DOCKER_PATH }}'
            - '{{ NGINX_DOCKER_CONF_PATH }}'
            - '{{ NGINX_SITES_ENABLED_PATH }}'
            - '{{ NGINX_SNIPPETS_PATH }}'

        - name: Create Nginx ssl directory
          file:
            path: '{{ NGINX_DOCKER_SSL_PATH }}'
            state: directory
            owner: '{{ NGINX_USER }}'
            group: root
            mode: 0500

        - name: Apply Nginx docker config
          copy:
            src: default.conf
            dest: '{{ NGINX_DOCKER_CONF_PATH }}/default.conf'
            owner: '{{ NGINX_USER }}'
            group: root
            mode: 0644

        - name: Apply Nginx Docker Compose template
          template:
            src: docker_compose.yml.j2
            dest: '{{ NGINX_DOCKER_PATH }}/docker-compose.yml'
            owner: '{{ NGINX_USER }}'
            group: root
            mode: 0644

      become: true

    - name: Copy ssl cert
      copy:
        src: '{{ SSL_CERT_PATH }}'
        dest: '{{ NGINX_SSL_CERT_PATH }}'
        owner: '{{ NGINX_USER }}'
        mode: 0400
      become: true

    - name: Copy ssl key
      copy:
        src: '{{ SSL_KEY_PATH }}'
        dest: '{{ NGINX_SSL_KEY_PATH }}'
        owner: '{{ NGINX_USER }}'
        mode: 0400
      become: true

    - name: Copy dh group
      copy:
        src: '{{ DH_PATH }}'
        dest: '{{ NGINX_DH_PATH }}'
        owner: '{{ NGINX_USER }}'
        mode: 0400
      become: true

    - name: Apply headers config
      template:
        src: headers.conf.j2
        dest: '{{ NGINX_SNIPPETS_PATH }}/headers.conf'
        mode: 0644
      become: true

    - name: Apply ssl config
      template:
        src: ssl-params.j2
        dest: '{{ NGINX_SNIPPETS_PATH }}/ssl-params.conf'
        mode: 0644
      become: true

    - name: Start Nginx
      shell: docker compose down && docker compose up -d
      args:
        chdir: '{{ NGINX_DOCKER_PATH }}'

  tags: nginx
